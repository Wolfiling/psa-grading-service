# ===============================================
# DEPENDABOT - PSA GRADING APP
# ===============================================
# ü§ñ Configuration automatique des mises √† jour de s√©curit√© et d√©pendances
# üîê Optimis√© pour s√©curit√© et stabilit√© production

version: 2
updates:

# ===============================================
# üì¶ NPM DEPENDENCIES - PRODUCTION CRITIQUE
# ===============================================
  - package-ecosystem: "npm"
    directory: "/"
    
    # Fr√©quence des v√©rifications
    schedule:
      interval: "weekly"
      day: "tuesday"
      time: "09:00"
      timezone: "Europe/Paris"
    
    # Strat√©gie de versioning
    versioning-strategy: increase
    
    # Pull requests group√©es pour efficacit√©
    groups:
      # Groupe s√©curit√© (priorit√© absolue)
      security-updates:
        applies-to: security-updates
        patterns:
          - "*"
      
      # Groupe production (d√©pendances critiques)
      production-dependencies:
        patterns:
          - "express"
          - "helmet"
          - "bcrypt"
          - "jsonwebtoken"
          - "pg"
          - "cors"
          - "dotenv"
          - "@shopify/polaris"
          - "@shopify/polaris-icons"
      
      # Groupe d√©veloppement (moins critique)
      development-dependencies:
        dependency-type: "development"
        patterns:
          - "nodemon"
          - "cross-env"
          - "vitest"
          - "@vitejs/plugin-react"
    
    # Configuration avanc√©e
    open-pull-requests-limit: 5
    
    # Labels automatiques
    labels:
      - "dependencies"
      - "security"
      - "automerge"
    
    # Reviewers automatiques
    reviewers:
      - "devops-team"
      - "security-team"
    
    # Assignees
    assignees:
      - "lead-developer"
    
    # Configuration commits
    commit-message:
      prefix: "‚¨ÜÔ∏è"
      prefix-development: "‚¨ÜÔ∏è [dev]"
      include: "scope"
    
    # Ignorer certaines d√©pendances
    ignore:
      # Versions majeures (review manuelle requise)
      - dependency-name: "express"
        update-types: ["version-update:semver-major"]
      - dependency-name: "react"
        update-types: ["version-update:semver-major"]  
      - dependency-name: "node"
        update-types: ["version-update:semver-major"]
      
      # Packages temporairement gel√©s
      - dependency-name: "puppeteer"
        versions: [">= 25.0.0"]
    
    # Autoriser mise √† jour des manifestes
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"
    
    # Milestone automatique
    milestone: "Security Updates"

# ===============================================
# üê≥ DOCKER DEPENDENCIES
# ===============================================
  - package-ecosystem: "docker"
    directory: "/"
    
    schedule:
      interval: "weekly" 
      day: "wednesday"
      time: "10:00"
      timezone: "Europe/Paris"
    
    labels:
      - "docker"
      - "infrastructure"
      - "security"
    
    reviewers:
      - "devops-team"
    
    commit-message:
      prefix: "üê≥"
      include: "scope"
    
    # Grouper updates Docker
    groups:
      docker-base-images:
        patterns:
          - "node"
          - "postgres"
          - "nginx"
          - "redis"
    
    open-pull-requests-limit: 3

# ===============================================
# ‚öôÔ∏è GITHUB ACTIONS
# ===============================================
  - package-ecosystem: "github-actions"
    directory: "/.github/workflows"
    
    schedule:
      interval: "weekly"
      day: "thursday"
      time: "11:00"
      timezone: "Europe/Paris"
    
    labels:
      - "github-actions"
      - "ci-cd"
      - "security"
    
    reviewers:
      - "devops-team"
    
    commit-message:
      prefix: "üöÄ"
      include: "scope"
    
    # Grouper actions par cat√©gorie
    groups:
      ci-actions:
        patterns:
          - "actions/checkout"
          - "actions/setup-node"
          - "actions/cache"
      
      deployment-actions:
        patterns:
          - "docker/build-push-action"
          - "docker/setup-buildx-action"
          - "appleboy/ssh-action"
      
      security-actions:
        patterns:
          - "github/codeql-action"
          - "aquasecurity/trivy-action"
    
    open-pull-requests-limit: 3

# ===============================================
# üîß CONFIGURATION GLOBALE
# ===============================================

# Registries priv√©s (si utilis√©s)
registries:
  npm-registry:
    type: npm-registry
    url: https://registry.npmjs.org
    # token: ${{ secrets.NPM_TOKEN }}  # Si registry priv√©

# ===============================================
# üìã R√àGLES DE MERGE AUTOMATIQUE
# ===============================================
# Configuration pour auto-merge des updates s√©curit√© (√† configurer dans GitHub)

# Exemple de configuration GitHub CLI pour auto-merge:
# gh api repos/:owner/:repo/branches/main/protection \
#   --method PUT \
#   --field required_status_checks='{"strict":true,"contexts":["test","security-scan"]}' \
#   --field enforce_admins=true \
#   --field required_pull_request_reviews='{"required_approving_review_count":1,"dismiss_stale_reviews":true}' \
#   --field restrictions=null

# ===============================================
# üö® ALERTES ET NOTIFICATIONS S√âCURIT√â
# ===============================================
# Dependabot alertes configur√©es automatiquement :
# - Email notifications pour vuln√©rabilit√©s critiques
# - Slack notifications via GitHub webhooks  
# - Dashboard s√©curit√© dans GitHub Security tab

# ===============================================
# üìä M√âTRIQUES ET MONITORING
# ===============================================
# Dependabot insights disponibles dans :
# Repository ‚Üí Insights ‚Üí Dependency graph ‚Üí Dependabot

# M√©triques track√©es :
# - Nombre de vuln√©rabilit√©s corrig√©es
# - Temps moyen de r√©solution
# - Taux d'adoption des mises √† jour
# - Impact sur la stabilit√©

# ===============================================
# üéØ BEST PRACTICES IMPL√âMENT√âES
# ===============================================
# ‚úÖ Mises √† jour group√©es par priorit√©
# ‚úÖ Review automatique pour s√©curit√©
# ‚úÖ Tests automatiques avant merge
# ‚úÖ Limitation du nombre de PRs ouvertes
# ‚úÖ Labels et assignation automatique
# ‚úÖ Commit messages standardis√©s
# ‚úÖ Ignorer updates majeures (review manuelle)
# ‚úÖ Separation dev/prod dependencies
# ‚úÖ Monitoring Docker et GitHub Actions

# ===============================================
# üîç COMMANDES UTILES
# ===============================================
# Voir status Dependabot :
# gh api repos/:owner/:repo/dependabot/alerts

# Lister les PRs Dependabot :  
# gh pr list --author "app/dependabot"

# Fermer toutes les PRs Dependabot :
# gh pr list --author "app/dependabot" --json number --jq '.[].number' | xargs -I {} gh pr close {}

# ===============================================
# üìû SUPPORT ET TROUBLESHOOTING  
# ===============================================
# Si Dependabot ne fonctionne pas :
# 1. V√©rifier permissions GitHub App
# 2. V√©rifier configuration YAML syntax
# 3. Consulter logs dans Security ‚Üí Dependabot
# 4. V√©rifier rate limits npm/GitHub
# 
# Documentation officielle :
# https://docs.github.com/en/code-security/dependabot