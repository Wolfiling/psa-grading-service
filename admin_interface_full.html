<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PSA - Administration</title>
    <link rel="icon" type="image/png" href="shopify-psa-logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f6f6f7;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #003366, #0066cc);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #003366;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #003366;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #003366;
        }

        .btn {
            background: #003366;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #004080;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending {
            background: #fef3cd;
            color: #856404;
        }

        .badge-progress {
            background: #cce5ff;
            color: #003366;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .filters {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }

        .filter-input,
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #003366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto; /* CRITIQUE: Permettre le scroll sur toute la modal */
            padding: 20px 0; /* CRITIQUE: Ajouter du padding vertical pour éviter le collage aux bords */
        }

        .modal-content {
            background: white;
            margin: 0 auto; /* CRITIQUE: Centrage horizontal seulement, pas de marge verticale */
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px; /* CRITIQUE: Augmenter la largeur max pour l'interface avancée */
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: calc(100vh - 40px); /* CRITIQUE: Hauteur max moins le padding */
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #003366;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto; /* CRITIQUE: Permettre le scroll dans le contenu de la modal */
            flex: 1; /* CRITIQUE: Prendre l'espace disponible */
            min-height: 0; /* CRITIQUE: Permettre au flex de rétrécir */
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-textarea {
            height: 100px;
            resize: vertical;
        }

        /* Enhanced Form Styles */
        .form-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active::after {
            background: #003366;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            z-index: 2;
            position: relative;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #003366;
            color: white;
        }

        .step-label {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            font-weight: 500;
        }

        .step.active .step-label {
            color: #003366;
            font-weight: 600;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-section {
            margin-bottom: 2rem;
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: #003366;
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group.flex-2 {
            grid-column: span 2;
        }

        .input-wrapper {
            position: relative;
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 1.2rem;
        }

        .search-results {
            position: fixed; /* CRITIQUE: Position fixe pour déborder du modal */
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10000; /* CRITIQUE: Z-index au-dessus de toutes les modals (2000) */
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            min-width: 200px;
        }

        .search-result {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s ease;
        }

        .search-result:hover {
            background: #f8f9fa;
        }

        .search-result-image {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }

        .search-result-info {
            flex: 1;
        }

        /* Styles pour les suggestions TaskMaster */
        .suggestion-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s ease;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .suggestion-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .suggestion-meta span {
            background: #e5e7eb;
            color: #6b7280;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .suggestion-image {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
        }

        .no-results {
            padding: 1rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .manual-toggle {
            margin-top: 1rem;
            text-align: center;
        }

        .toggle-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .manual-entry-fields {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .card-preview {
            margin-top: 1.5rem;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid #e9ecef;
        }

        .card-info {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .card-image-wrapper img {
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
        }

        .grading-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .grading-card {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .grading-card:hover {
            border-color: #003366;
        }

        .grading-card.selected {
            border-color: #003366;
            background: #f8f9ff;
        }

        .grading-price {
            font-size: 1.8rem;
            font-weight: 800;
            color: #28a745;
        }

        .price-summary {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .upload-zone:hover {
            border-color: #003366;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-next, .btn-prev {
            background: #007bff;
        }

        .btn-submit {
            background: linear-gradient(135deg, #28a745, #20c997);
            font-size: 1.1rem;
            padding: 0.875rem 2rem;
        }

        .order-summary {
            background: #f8f9ff;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        /* Nouveaux styles pour le gestionnaire multi-cartes */
        .cards-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            min-height: 100px;
            background: #fafafa;
        }

        .card-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        .card-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-item-image {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            background: #f5f5f5;
            border: 1px solid #ddd;
        }

        .card-item-info {
            flex: 1;
        }

        .card-item-name {
            font-weight: 600;
            color: #003366;
            margin-bottom: 0.25rem;
        }

        .card-item-details {
            font-size: 0.9rem;
            color: #666;
        }

        .card-item-source {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .card-item-source.taskmaster {
            background: #e3f2fd;
            color: #1976d2;
        }

        .card-item-source.manual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .card-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-item-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-item-remove:hover {
            background: #c82333;
        }

        /* Modal d'ajout de carte */
        .card-add-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px 0;
        }

        .card-add-modal-content {
            background: white;
            margin: 0 auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .card-add-modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #003366, #0066cc);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .card-add-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .card-add-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }

        .card-add-modal-close:hover {
            opacity: 1;
        }

        .card-add-modal-body {
            padding: 2rem;
            overflow-y: visible; /* CRITIQUE: Permettre aux suggestions de déborder */
            flex: 1;
            min-height: 0;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-option {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            border-color: #003366;
        }

        .mode-option.selected {
            border-color: #003366;
            background: #f8f9ff;
        }

        .mode-option-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .mode-option-title {
            font-weight: 600;
            color: #003366;
            margin-bottom: 0.5rem;
        }

        .mode-option-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .form-mode {
            display: none;
        }

        .form-mode.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .mode-selector {
                grid-template-columns: 1fr;
            }

            .card-item {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏆 Dashboard PSA Grading</h1>
        <p>Administration des demandes de gradation PSA</p>
    </div>

    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <!-- Core Business Stats -->
            <div class="stat-card">
                <div class="stat-number" id="totalRequests">-</div>
                <div class="stat-label">Total demandes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingRequests">-</div>
                <div class="stat-label">En attente</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="progressRequests">-</div>
                <div class="stat-label">En cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedRequests">-</div>
                <div class="stat-label">Terminées</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">-</div>
                <div class="stat-label">Revenus total</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #ffa500;">
                <div class="stat-number" id="pendingPaymentRequests">-</div>
                <div class="stat-label">Paiements en attente</div>
            </div>

            <!-- PSA Scraper Stats -->
            <div class="stat-card" style="border-left: 4px solid #6f42c1;">
                <div class="stat-number" id="psaScrapingCount">-</div>
                <div class="stat-label">🔍 PSA à scraper</div>
                <div class="stat-status" id="psaScrapingStatus">-</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #17a2b8;">
                <div class="stat-number" id="psaUpdatedToday">-</div>
                <div class="stat-label">📊 PSA mis à jour aujourd'hui</div>
            </div>

            <!-- Email System Stats -->
            <div class="stat-card" style="border-left: 4px solid #e83e8c;">
                <div class="stat-number" id="emailsSentToday">-</div>
                <div class="stat-label">📧 Emails envoyés</div>
                <div class="stat-status" id="emailSystemStatus">-</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #dc3545;">
                <div class="stat-number" id="pendingEmails">-</div>
                <div class="stat-label">📬 Emails en attente</div>
            </div>

            <!-- Video System Stats -->
            <div class="stat-card" style="border-left: 4px solid #fd7e14;">
                <div class="stat-number" id="qrCodesGenerated">-</div>
                <div class="stat-label">📱 QR codes générés</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #20c997;">
                <div class="stat-number" id="videosSubmitted">-</div>
                <div class="stat-label">🎥 Vidéos soumises</div>
                <div class="stat-status" id="videoSystemStatus">-</div>
            </div>
        </div>

        <!-- Section Paiements en Attente -->
        <div class="main-content" style="margin-bottom: 2rem;">
            <div class="content-header">
                <h2 class="content-title" style="color: #ffa500;">💳 Gestion des Paiements en Attente</h2>
                <div>
                    <button class="btn" onclick="refreshPendingPayments()" style="background: #ffa500;">🔄 Actualiser</button>
                </div>
            </div>

            <!-- Loading State for Pending Payments -->
            <div id="loadingPendingPayments" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Chargement des paiements en attente...</p>
            </div>

            <!-- Pending Payments Table -->
            <div id="pendingPaymentsContainer" class="table-container" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID Soumission</th>
                            <th>Client</th>
                            <th>Carte(s)</th>
                            <th>Type PSA</th>
                            <th>Prix</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingPaymentsTable">
                    </tbody>
                </table>
            </div>

            <!-- Empty State for Pending Payments -->
            <div id="emptyPendingPayments" class="empty-state" style="display: none;">
                <div class="empty-state-icon">💳</div>
                <h3>Aucun paiement en attente</h3>
                <p>Les demandes avec l'option "Payer plus tard" apparaîtront ici.</p>
            </div>
        </div>

        <!-- PSA Scraper Control Panel -->
        <div class="main-content" style="margin-bottom: 2rem;">
            <div class="content-header">
                <h2 class="content-title" style="color: #6f42c1;">🔍 PSA Scraper - Contrôle Temps Réel</h2>
                <div>
                    <button class="btn" onclick="refreshPSAStatus()" style="background: #17a2b8;">📊 Statut</button>
                    <button class="btn" onclick="scrapePendingSubmissions()" style="background: #6f42c1;">🔄 Scraper Tout</button>
                    <button class="btn" onclick="showPSALinkModal()" style="background: #28a745;">🔗 Lier PSA</button>
                </div>
            </div>

            <!-- PSA Status Display -->
            <div class="filters" style="padding: 1rem 2rem;">
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">🔧 Statut Scraper</label>
                        <div id="psaScraperStatus" class="badge badge-pending">Chargement...</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">🔐 Session PSA</label>
                        <div id="psaSessionStatus" class="badge badge-pending">Vérifie...</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">⏰ Dernière Activité</label>
                        <div id="psaLastActivity" style="font-size: 0.9rem; color: #666;">-</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">📊 Soumissions en Attente</label>
                        <div id="psaPendingCount" class="stat-number" style="font-size: 1.5rem; color: #6f42c1;">-</div>
                    </div>
                </div>
            </div>

            <!-- PSA Scraper Results -->
            <div id="psaScrapingResults" class="table-container" style="display: none;">
                <h4 style="padding: 1rem 2rem; margin: 0; background: #f8f9fa; border-bottom: 1px solid #e5e7eb; color: #6f42c1;">
                    📈 Résultats du Scraping
                </h4>
                <div id="psaResultsContent" style="padding: 1rem 2rem; max-height: 300px; overflow-y: auto;">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- PSA Pending Submissions Table -->
            <div id="psaPendingSubmissions" class="table-container" style="display: none;">
                <h4 style="padding: 1rem 2rem; margin: 0; background: #f8f9fa; border-bottom: 1px solid #e5e7eb; color: #6f42c1;">
                    ⏳ Soumissions PSA en Attente de Scraping
                </h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID Soumission</th>
                            <th>N° PSA</th>
                            <th>Client</th>
                            <th>Carte</th>
                            <th>Statut</th>
                            <th>Dernier Scraping</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="psaPendingTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h2 class="content-title">Demandes de gradation</h2>
                <div>
                    <button id="btnNewOrder" class="btn" style="background: #28a745;" onclick="openNewCommandModal()">➕ Nouvelle Commande</button>
                    <button class="btn" onclick="refreshData()">🔄 Actualiser</button>
                    <button class="btn" onclick="generateQRCodes()" style="background: #fd7e14;">📱 QR Codes</button>
                    <button class="btn" onclick="sendBulkEmails()" style="background: #e83e8c;">📧 Emails</button>
                    <a href="/status" class="btn" style="background: #17a2b8;">📊 Suivi Client</a>
                    <a href="/" class="btn btn-danger">🏠 Site Public</a>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Recherche</label>
                        <input type="text" id="searchInput" class="filter-input" placeholder="Nom de carte, email..." onkeyup="filterRequests()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Statut</label>
                        <select id="statusFilter" class="filter-select" onchange="filterRequests()">
                            <option value="">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="in_progress">En cours</option>
                            <option value="completed">Terminé</option>
                            <option value="cancelled">Annulé</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Type PSA</label>
                        <select id="typeFilter" class="filter-select" onchange="filterRequests()">
                            <option value="">Tous les types</option>
                            <option value="value">PSA Value</option>
                            <option value="regular">PSA Regular</option>
                            <option value="express">PSA Express</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Chargement des demandes...</p>
            </div>

            <!-- Table -->
            <div id="requestsContainer" class="table-container" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Carte</th>
                            <th>Type PSA</th>
                            <th>Prix</th>
                            <th>Statut</th>
                            <th>PSA #</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable">
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyRequests" class="empty-state" style="display: none;">
                <div class="empty-state-icon">📋</div>
                <h3>Aucune demande trouvée</h3>
                <p>Les demandes de gradation PSA apparaîtront ici.</p>
            </div>
        </div>
    </div>

    <!-- Modal d'ajout de carte -->
    <div id="cardAddModal" class="card-add-modal">
        <div class="card-add-modal-content">
            <div class="card-add-modal-header">
                <h3 class="card-add-modal-title">✨ Ajouter une Carte</h3>
                <button class="card-add-modal-close" onclick="closeCardAddModal()">&times;</button>
            </div>
            <div class="card-add-modal-body">
                <!-- Sélecteur de Mode -->
                <div class="mode-selector">
                    <div class="mode-option selected" data-mode="taskmaster" onclick="selectMode('taskmaster')">
                        <div class="mode-option-icon">🔍</div>
                        <div class="mode-option-title">Recherche TaskMaster</div>
                        <div class="mode-option-desc">Rechercher dans la base de données</div>
                    </div>
                    <div class="mode-option" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-option-icon">✏️</div>
                        <div class="mode-option-title">Saisie Manuelle</div>
                        <div class="mode-option-desc">Ajouter les informations manuellement</div>
                    </div>
                </div>

                <!-- Mode TaskMaster -->
                <div id="taskmasterMode" class="form-mode active">
                    <div class="form-group">
                        <label class="form-label">Rechercher une carte</label>
                        <div class="search-wrapper">
                            <input type="text" id="tmCardSearchInput" class="form-input" 
                                   placeholder="Tapez le nom d'une carte (ex: Pikachu VMAX)..." 
                                   autocomplete="off">
                            <div class="search-icon">🔍</div>
                        </div>
                        <div id="tmSearchResults" class="search-results"></div>
                    </div>
                </div>

                <!-- Mode Manuel -->
                <div id="manualMode" class="form-mode">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom de la carte *</label>
                            <input type="text" id="manualCardName" class="form-input" 
                                   placeholder="Ex: Pikachu VMAX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Série</label>
                            <input type="text" id="manualCardSeries" class="form-input" 
                                   placeholder="Ex: Brilliant Stars">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Numéro</label>
                            <input type="text" id="manualCardNumber" class="form-input" 
                                   placeholder="Ex: 188/172">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rareté</label>
                            <input type="text" id="manualCardRarity" class="form-input" 
                                   placeholder="Ex: Secret Rare">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Année</label>
                            <input type="number" id="manualCardYear" class="form-input" 
                                   placeholder="Ex: 2022" min="1996" max="2025">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL Image (optionnel)</label>
                            <input type="url" id="manualCardImageUrl" class="form-input" 
                                   placeholder="https://...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes additionnelles</label>
                        <textarea id="manualCardNotes" class="form-textarea" 
                                  placeholder="Condition, variante, détails..." rows="3"></textarea>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                    <button type="button" class="btn" onclick="closeCardAddModal()" 
                            style="background: #6c757d;">Annuler</button>
                    <button type="button" class="btn" onclick="addCardToList()" 
                            style="background: #28a745;">➕ Ajouter cette carte</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifier la demande</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select id="modalStatus" class="form-select" required>
                            <option value="pending">En attente</option>
                            <option value="in_progress">En cours</option>
                            <option value="shipped">Expédié</option>
                            <option value="at_psa">Chez PSA</option>
                            <option value="graded">Gradé</option>
                            <option value="returned">Retourné</option>
                            <option value="completed">Terminé</option>
                            <option value="cancelled">Annulé</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Numéro de suivi</label>
                        <input type="text" id="modalTracking" class="form-input" placeholder="Ex: 1Z999AA1234567890">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Numéro PSA</label>
                        <input type="text" id="modalPsaNumber" class="form-input" placeholder="Ex: PSA-12345678">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Commentaires</label>
                        <textarea id="modalComments" class="form-textarea" placeholder="Commentaires additionnels..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">💾 Sauvegarder</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add New Command Modal - ENHANCED VERSION -->
    <div id="addModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90vw;">
            <div class="modal-header">
                <h3 class="modal-title">✨ Nouvelle Commande PSA - Interface Avancée</h3>
                <button class="close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Progress Steps -->
                <div class="form-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Client & Carte</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Détails PSA</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Images & Finalisation</div>
                    </div>
                </div>

                <form id="addForm">
                    <!-- STEP 1: Client & Carte -->
                    <div class="form-step active" data-step="1">
                        <div class="form-section">
                            <h4 class="section-title">👤 Informations Client</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email Client *</label>
                                    <div class="input-wrapper">
                                        <input type="email" id="addEmail" class="form-input" placeholder="client@email.com" required>
                                        <div class="input-feedback"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4 class="section-title">🎴 Gestionnaire de Cartes Multi-Cartes</h4>
                            
                            <!-- Bouton Ajouter Carte -->
                            <div class="add-card-section" style="margin-bottom: 1.5rem; text-align: center;">
                                <button type="button" class="btn" onclick="openCardManager()" style="background: #28a745; font-size: 1.1rem; padding: 0.75rem 2rem;">
                                    ➕ Ajouter une carte
                                </button>
                                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">Minimum: 1 carte • Maximum: 20 cartes</p>
                            </div>
                            
                            <!-- Liste des Cartes Ajoutées -->
                            <div id="cardsList" class="cards-list" style="display: none;">
                                <h5 style="margin-bottom: 1rem; color: #003366;">📋 Cartes ajoutées (<span id="cardsCount">0</span>)</h5>
                                <div id="cardsContainer" class="cards-container"></div>
                                
                                <!-- Résumé Prix -->
                                <div class="price-summary-cards" style="margin-top: 1rem; padding: 1rem; background: #f8f9ff; border: 2px solid #e3f2fd; border-radius: 8px;">
                                    <div class="price-row">
                                        <span>Nombre de cartes:</span>
                                        <strong id="totalCardsCount">0</strong>
                                    </div>
                                    <div class="price-row">
                                        <span>Prix par carte:</span>
                                        <strong id="pricePerCard">-</strong>
                                    </div>
                                    <div class="price-row" style="border-top: 1px solid #ddd; padding-top: 0.5rem; margin-top: 0.5rem;">
                                        <span style="font-size: 1.1rem;">Prix total:</span>
                                        <strong id="totalPrice" style="font-size: 1.2rem; color: #28a745;">0 €</strong>
                                    </div>
                                </div>
                            </div>

                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Rareté</label>
                            <div id="cardPreview" class="card-preview" style="display: none;">
                                <div class="card-info">
                                    <div class="card-image-wrapper">
                                        <img id="previewImage" src="" alt="Card Preview">
                                    </div>
                                    <div class="card-details">
                                        <h5 id="previewName"></h5>
                                        <p id="previewSeries"></p>
                                        <p id="previewNumber"></p>
                                        <span id="previewRarity" class="rarity-badge"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button type="button" class="btn btn-next" onclick="nextStep()">Suivant →</button>
                        </div>
                    </div>

                    <!-- STEP 2: Détails PSA -->
                    <div class="form-step" data-step="2">
                        <div class="form-section">
                            <h4 class="section-title">🏆 Configuration PSA</h4>
                            <div class="grading-options">
                                <div class="form-group">
                                    <label class="form-label">Type PSA *</label>
                                    <div class="grading-cards">
                                        <div class="grading-card" data-type="value">
                                            <div class="grading-header">
                                                <div class="grading-icon">💰</div>
                                                <div class="grading-name">PSA Value</div>
                                            </div>
                                            <div class="grading-price">30€</div>
                                            <div class="grading-time">30-45 jours</div>
                                            <div class="grading-desc">Économique, fiable</div>
                                        </div>
                                        
                                        <div class="grading-card" data-type="regular">
                                            <div class="grading-header">
                                                <div class="grading-icon">⚡</div>
                                                <div class="grading-name">PSA Regular</div>
                                            </div>
                                            <div class="grading-price">50€</div>
                                            <div class="grading-time">15-20 jours</div>
                                            <div class="grading-desc">Service standard</div>
                                        </div>
                                        
                                        <div class="grading-card" data-type="express">
                                            <div class="grading-header">
                                                <div class="grading-icon">🚀</div>
                                                <div class="grading-name">PSA Express</div>
                                            </div>
                                            <div class="grading-price">100€</div>
                                            <div class="grading-time">5-7 jours</div>
                                            <div class="grading-desc">Ultra rapide</div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="addGradingType" required>
                                </div>

                                <div class="price-summary">
                                    <div class="price-row">
                                        <span>Prix de base:</span>
                                        <span id="basePrice">0€</span>
                                    </div>
                                    <div class="price-row total">
                                        <span>Prix final:</span>
                                        <span id="finalPrice">0€</span>
                                    </div>
                                    <input type="hidden" id="addPrice">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4 class="section-title">📍 Source & Détails</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Source</label>
                                    <select id="addCardSource" class="form-select">
                                        <option value="website">🌐 Site Web</option>
                                        <option value="whatnot">📺 Whatnot Live</option>
                                        <option value="store">🏪 Magasin physique</option>
                                        <option value="other">❓ Autre</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Conditional fields for Whatnot -->
                            <div id="whatnotFields" class="conditional-fields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Nom d'utilisateur Whatnot</label>
                                        <input type="text" id="whatnotUsername" class="form-input" placeholder="@username">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date du live</label>
                                        <input type="date" id="liveDate" class="form-input">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button type="button" class="btn btn-prev" onclick="prevStep()">← Précédent</button>
                            <button type="button" class="btn btn-next" onclick="nextStep()">Suivant →</button>
                        </div>
                    </div>

                    <!-- STEP 3: Images & Finalisation -->
                    <div class="form-step" data-step="3">
                        <div class="form-section">
                            <h4 class="section-title">📸 Images de la Carte</h4>
                            <div class="image-upload-area">
                                <div class="upload-zone" id="uploadZone">
                                    <div class="upload-icon">📁</div>
                                    <div class="upload-text">
                                        <strong>Cliquez pour sélectionner</strong> ou glissez-déposez vos images
                                    </div>
                                    <div class="upload-hint">JPG, PNG, WebP • Max 5MB par image</div>
                                    <input type="file" id="addCardImage" accept="image/*" multiple style="display: none;">
                                </div>
                                
                                <div id="imagePreview" class="image-preview-grid"></div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4 class="section-title">💬 Commentaires & Instructions</h4>
                            <div class="form-group">
                                <label class="form-label">Commentaires additionnels</label>
                                <textarea id="addComments" class="form-textarea" placeholder="Instructions spéciales, condition de la carte, historique..." rows="4"></textarea>
                                <div class="character-count">
                                    <span id="commentCount">0</span> / 500 caractères
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="form-section">
                            <h4 class="section-title">📋 Résumé de la Commande</h4>
                            <div class="order-summary">
                                <div class="summary-row">
                                    <span class="summary-label">Client:</span>
                                    <span id="summaryEmail">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Service:</span>
                                    <span id="summaryService">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Nombre de cartes:</span>
                                    <strong id="summaryCardsCount">0</strong>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Prix par carte:</span>
                                    <span id="summaryPricePerCard">-</span>
                                </div>
                                <div class="summary-row" style="border-top: 1px solid #ddd; padding-top: 0.5rem; margin-top: 0.5rem;">
                                    <span class="summary-label" style="font-size: 1.1rem;">Prix total:</span>
                                    <strong id="summaryTotalPrice" style="font-size: 1.2rem; color: #28a745;">0 €</strong>
                                </div>
                            </div>
                            
                            <!-- Liste détaillée des cartes -->
                            <div id="summaryCardsList" style="margin-top: 1.5rem; display: none;">
                                <h5 style="color: #003366; margin-bottom: 1rem;">🎴 Détail des cartes</h5>
                                <div id="summaryCardsContainer" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button type="button" class="btn btn-prev" onclick="prevStep()">← Précédent</button>
                            <button type="submit" class="btn btn-submit">✨ Créer la Commande</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal détails de demande (NOUVEAU) -->
    <div id="requestModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">📄 Détails de la Demande <span id="modalRequestId"></span></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Informations Client -->
                <div class="modal-section">
                    <h4 class="section-title">👤 Informations Client</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span id="modalCustomerEmail"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date de création:</span>
                            <span id="modalCreatedAt"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Source:</span>
                            <span id="modalCardSource"></span>
                        </div>
                    </div>
                </div>

                <!-- Service PSA -->
                <div class="modal-section">
                    <h4 class="section-title">🏆 Service PSA</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Type:</span>
                            <span id="modalGradingType"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prix total:</span>
                            <strong id="modalPrice" style="color: #28a745;"></strong>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Statut:</span>
                            <select id="statusSelect" class="form-select" style="max-width: 150px;">
                                <option value="pending">En attente</option>
                                <option value="paid">Payé</option>
                                <option value="processing">En cours</option>
                                <option value="shipped">Expédié</option>
                                <option value="completed">Terminé</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Détails des Cartes -->
                <div class="modal-section">
                    <h4 class="section-title">🎴 Cartes (<span id="modalCardsCount">1</span>)</h4>
                    
                    <!-- Affichage Multi-cartes -->
                    <div id="modalCardsContainer" class="modal-cards-list" style="display: none;">
                        <!-- Généré dynamiquement par JavaScript -->
                    </div>
                    
                    <!-- Affichage Carte Unique (Legacy) -->
                    <div id="modalSingleCardContainer" class="single-card-display">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Nom:</span>
                                <span id="modalCardName"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Série:</span>
                                <span id="modalCardSeries"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Numéro:</span>
                                <span id="modalCardNumber"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Suivi & Informations PSA -->
                <div class="modal-section">
                    <h4 class="section-title">📦 Suivi & PSA</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Estimation:</span>
                            <span id="modalEstimatedCompletion"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tracking:</span>
                            <span id="modalTrackingNumber"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Numéro PSA:</span>
                            <span id="modalPsaNumber"></span>
                        </div>
                    </div>
                </div>

                <!-- Commentaires -->
                <div class="modal-section">
                    <h4 class="section-title">💬 Commentaires</h4>
                    <div class="comments-display" id="modalNotes">
                        <!-- Généré dynamiquement -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="modal-section">
                    <h4 class="section-title">⚙️ Actions</h4>
                    <div class="modal-actions">
                        <button class="btn btn-small" onclick="updateRequestStatus()">Mettre à jour le statut</button>
                        <button id="modalPaymentButton" class="btn btn-small" style="background: #28a745; display: none;">Envoyer lien paiement</button>
                        <button id="modalTrackingButton" class="btn btn-small" style="background: #17a2b8; display: none;">Modifier tracking</button>
                        <button id="modalVideoButton" class="btn btn-small" style="background: #6f42c1; display: none;">Voir vidéo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PSA Link Modal -->
    <div id="psaLinkModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">🔗 Lier Soumission à PSA</h3>
                <button class="close" onclick="closePSALinkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ID Soumission</label>
                    <input type="text" id="psaLinkSubmissionId" class="form-input" placeholder="PSA-XXXXXXXXXXXX" required>
                    <small style="color: #666;">ID de la soumission dans notre système</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Numéro PSA</label>
                    <input type="text" id="psaLinkNumber" class="form-input" placeholder="12345678" required>
                    <small style="color: #666;">Numéro de soumission PSA reçu après envoi</small>
                </div>
                <div style="text-align: right; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closePSALinkModal()" style="background: #6c757d; margin-right: 1rem;">Annuler</button>
                    <button type="button" class="btn" onclick="linkPSASubmission()" style="background: #28a745;">🔗 Lier et Scraper</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email/QR Batch Operations Modal -->
    <div id="batchOpsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">📧 Opérations en Lot</h3>
                <button class="close" onclick="closeBatchOpsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4 class="section-title">📧 Envoi d'Emails en Lot</h4>
                    <div class="form-group">
                        <label class="form-label">Type d'Email</label>
                        <select id="batchEmailType" class="form-select">
                            <option value="confirmation">Email de Confirmation</option>
                            <option value="qr_code">QR Code de Preuve Vidéo</option>
                            <option value="payment_reminder">Rappel de Paiement</option>
                            <option value="status_update">Mise à Jour Statut</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filtre Demandes</label>
                        <select id="batchEmailFilter" class="form-select">
                            <option value="pending">En Attente</option>
                            <option value="paid">Payées</option>
                            <option value="sent_to_psa">Envoyées à PSA</option>
                            <option value="all">Toutes</option>
                        </select>
                    </div>
                    <button type="button" class="btn" onclick="sendBatchEmails()" style="background: #e83e8c;">📧 Envoyer Emails</button>
                </div>

                <div class="form-section" style="margin-top: 2rem;">
                    <h4 class="section-title">📱 Génération QR Codes en Lot</h4>
                    <div class="form-group">
                        <label class="form-label">Type de QR</label>
                        <select id="batchQRType" class="form-select">
                            <option value="video_proof">Preuve Vidéo</option>
                            <option value="tracking">Suivi Commande</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filtre Demandes</label>
                        <select id="batchQRFilter" class="form-select">
                            <option value="paid">Payées (prêtes pour vidéo)</option>
                            <option value="missing_qr">QR Codes manquants</option>
                            <option value="all">Toutes</option>
                        </select>
                    </div>
                    <button type="button" class="btn" onclick="generateBatchQRCodes()" style="background: #fd7e14;">📱 Générer QR Codes</button>
                </div>

                <div style="text-align: right; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closeBatchOpsModal()" style="background: #6c757d;">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard JavaScript -->
    <script defer src="/js/admin-dashboard.js"></script>
    <script>
        // ========================================
        // PSA SCRAPER INTEGRATION FUNCTIONS
        // ========================================

        // Refresh PSA scraper status
        async function refreshPSAStatus() {
            try {
                console.log('🔄 Refreshing PSA scraper status...');
                
                const response = await fetch('/api/admin/psa-scraper/status', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    
                    // Update status badges
                    const scraperStatus = document.getElementById('psaScraperStatus');
                    const sessionStatus = document.getElementById('psaSessionStatus');
                    const lastActivity = document.getElementById('psaLastActivity');
                    
                    if (scraperStatus) {
                        scraperStatus.className = `badge ${status.initialized ? 'badge-completed' : 'badge-pending'}`;
                        scraperStatus.textContent = status.initialized ? '🟢 Initialisé' : '🔴 Non Initialisé';
                    }
                    
                    if (sessionStatus) {
                        sessionStatus.className = `badge ${status.session_active ? 'badge-completed' : 'badge-pending'}`;
                        sessionStatus.textContent = status.session_active ? '🟢 Connecté' : (status.logged_in ? '🟡 Connecté (vérification...)' : '🔴 Déconnecté');
                    }
                    
                    if (lastActivity) {
                        lastActivity.textContent = new Date(status.last_activity).toLocaleString('fr-FR');
                    }
                    
                    console.log('✅ PSA status updated:', status);
                } else {
                    console.error('❌ Failed to get PSA status:', data.message);
                }
                
                // Also refresh pending submissions count
                await refreshPSAPendingSubmissions();
                
            } catch (error) {
                console.error('❌ Error refreshing PSA status:', error);
            }
        }

        // Refresh pending PSA submissions
        async function refreshPSAPendingSubmissions() {
            try {
                const response = await fetch('/api/admin/psa-scraper/pending-submissions', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const pendingCount = document.getElementById('psaPendingCount');
                    if (pendingCount) {
                        pendingCount.textContent = data.count;
                    }
                    
                    // Update pending submissions table
                    updatePSAPendingTable(data.pending_submissions);
                    
                    // Show/hide table based on count
                    const pendingTable = document.getElementById('psaPendingSubmissions');
                    if (pendingTable) {
                        pendingTable.style.display = data.count > 0 ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.error('❌ Error refreshing pending submissions:', error);
            }
        }

        // Update PSA pending submissions table
        function updatePSAPendingTable(submissions) {
            const tableBody = document.getElementById('psaPendingTable');
            if (!tableBody) return;
            
            if (submissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Aucune soumission en attente</td></tr>';
                return;
            }
            
            tableBody.innerHTML = submissions.map(sub => `
                <tr>
                    <td>${sub.submission_id}</td>
                    <td>${sub.psa_submission_number || '-'}</td>
                    <td>${sub.customer_email}</td>
                    <td>${sub.card_name}</td>
                    <td>
                        <span class="badge badge-${sub.psa_status ? 'progress' : 'pending'}">
                            ${sub.psa_status || sub.status || 'Aucun statut PSA'}
                        </span>
                    </td>
                    <td>${sub.psa_last_scraped ? new Date(sub.psa_last_scraped).toLocaleString('fr-FR') : 'Jamais'}</td>
                    <td>
                        <button class="btn btn-small" onclick="scrapeSinglePSA('${sub.psa_submission_number}', '${sub.submission_id}')" style="background: #6f42c1;">
                            🔍 Scraper
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Scrape all pending PSA submissions
        async function scrapePendingSubmissions() {
            try {
                console.log('🚀 Starting bulk PSA scraping...');
                
                // Show loading state
                showPSALoadingState('Scraping de toutes les soumissions PSA en cours...');
                
                const response = await fetch('/api/admin/psa-scraper/scrape-all', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Bulk PSA scraping completed:', data);
                    
                    // Show results
                    showPSAResults(`✅ Scraping terminé avec succès!\n\n📊 ${data.scraped_count} soumissions mises à jour`, data.scraped_data);
                    
                    // Refresh data
                    await refreshPSAStatus();
                    await refreshData(); // Refresh main table
                    
                } else {
                    console.error('❌ Bulk PSA scraping failed:', data.message);
                    showPSAResults(`❌ Erreur lors du scraping: ${data.message}`, null);
                }
                
            } catch (error) {
                console.error('❌ Error during bulk PSA scraping:', error);
                showPSAResults(`❌ Erreur réseau: ${error.message}`, null);
            }
        }

        // Scrape single PSA submission
        async function scrapeSinglePSA(submissionNumber, submissionId = null) {
            try {
                console.log(`🎯 Scraping PSA submission: ${submissionNumber}`);
                
                showPSALoadingState(`Scraping de la soumission ${submissionNumber}...`);
                
                const response = await fetch('/api/admin/psa-scraper/scrape-submission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_number: submissionNumber,
                        submission_id: submissionId
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ PSA submission scraped:', data);
                    showPSAResults(`✅ Soumission ${submissionNumber} scrapée avec succès!`, [data.psa_data]);
                    
                    // Refresh data
                    await refreshPSAStatus();
                    await refreshData();
                    
                } else {
                    console.error('❌ PSA scraping failed:', data.message);
                    showPSAResults(`❌ Erreur: ${data.message}`, null);
                }
                
            } catch (error) {
                console.error('❌ Error scraping PSA submission:', error);
                showPSAResults(`❌ Erreur réseau: ${error.message}`, null);
            }
        }

        // Show PSA loading state
        function showPSALoadingState(message) {
            const resultsDiv = document.getElementById('psaScrapingResults');
            const contentDiv = document.getElementById('psaResultsContent');
            
            if (resultsDiv && contentDiv) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        <p style="color: #6f42c1; font-weight: 600;">${message}</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
            }
        }

        // Show PSA scraping results
        function showPSAResults(message, data) {
            const resultsDiv = document.getElementById('psaScrapingResults');
            const contentDiv = document.getElementById('psaResultsContent');
            
            if (resultsDiv && contentDiv) {
                let html = `<div style="margin-bottom: 1rem;"><strong>${message}</strong></div>`;
                
                if (data && data.length > 0) {
                    html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-top: 1rem;">';
                    html += '<h5 style="margin-bottom: 1rem; color: #6f42c1;">📋 Détails des données scrapées:</h5>';
                    
                    data.forEach((item, index) => {
                        const psaData = item.psaData || item;
                        html += `
                            <div style="border-left: 3px solid #6f42c1; padding-left: 1rem; margin-bottom: 1rem;">
                                <div><strong>Soumission:</strong> ${psaData.submissionNumber || 'N/A'}</div>
                                <div><strong>Statut:</strong> ${psaData.status || 'N/A'}</div>
                                <div><strong>Date Réception:</strong> ${psaData.receivedDate || 'N/A'}</div>
                                <div><strong>Date Estimée:</strong> ${psaData.estimatedGradingDate || 'N/A'}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                html += `<div style="text-align: right; margin-top: 1rem;">
                    <button class="btn btn-small" onclick="hidePSAResults()" style="background: #6c757d;">Fermer</button>
                </div>`;
                
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            }
        }

        // Hide PSA results
        function hidePSAResults() {
            const resultsDiv = document.getElementById('psaScrapingResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
        }

        // PSA Link Modal Functions
        function showPSALinkModal() {
            const modal = document.getElementById('psaLinkModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closePSALinkModal() {
            const modal = document.getElementById('psaLinkModal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('psaLinkSubmissionId').value = '';
                document.getElementById('psaLinkNumber').value = '';
            }
        }

        // Link PSA submission
        async function linkPSASubmission() {
            const submissionId = document.getElementById('psaLinkSubmissionId').value.trim();
            const psaNumber = document.getElementById('psaLinkNumber').value.trim();
            
            if (!submissionId || !psaNumber) {
                alert('⚠️ Veuillez remplir tous les champs');
                return;
            }
            
            try {
                console.log(`🔗 Linking ${submissionId} to PSA ${psaNumber}`);
                
                const response = await fetch('/api/admin/psa-scraper/link-submission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        psa_submission_number: psaNumber
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ PSA submission linked:', data);
                    alert(`✅ Soumission liée avec succès à PSA ${psaNumber}!`);
                    
                    closePSALinkModal();
                    await refreshPSAStatus();
                    await refreshData();
                    
                } else {
                    console.error('❌ Failed to link PSA submission:', data.message);
                    alert(`❌ Erreur: ${data.message}`);
                }
                
            } catch (error) {
                console.error('❌ Error linking PSA submission:', error);
                alert(`❌ Erreur réseau: ${error.message}`);
            }
        }

        // ========================================
        // EMAIL & QR CODE INTEGRATION FUNCTIONS
        // ========================================

        // Generate QR codes for requests
        async function generateQRCodes() {
            const modal = document.getElementById('batchOpsModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // Send bulk emails
        async function sendBulkEmails() {
            const modal = document.getElementById('batchOpsModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // Close batch operations modal
        function closeBatchOpsModal() {
            const modal = document.getElementById('batchOpsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Actually send batch emails
        async function sendBatchEmails() {
            const emailType = document.getElementById('batchEmailType').value;
            const filter = document.getElementById('batchEmailFilter').value;
            
            try {
                console.log(`📧 Sending batch emails: ${emailType} for ${filter} requests`);
                
                showBatchOperationLoading('📧 Envoi d\'emails en cours...', 'email');
                
                const response = await fetch('/api/admin/email/send-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_type: emailType,
                        status_filter: filter
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Batch emails sent:', data);
                    showBatchOperationResult(`✅ ${data.message}`, `📊 ${data.sent_count} emails envoyés sur ${data.total_requests} demandes`, 'success');
                    
                    // Refresh data
                    await refreshData();
                    
                } else {
                    console.error('❌ Batch emails failed:', data.message);
                    showBatchOperationResult(`❌ Erreur: ${data.message}`, null, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error sending batch emails:', error);
                showBatchOperationResult(`❌ Erreur réseau: ${error.message}`, null, 'error');
            }
        }

        // Actually generate batch QR codes
        async function generateBatchQRCodes() {
            const qrType = document.getElementById('batchQRType').value;
            const filter = document.getElementById('batchQRFilter').value;
            
            try {
                console.log(`📱 Generating batch QR codes: ${qrType} for ${filter} requests`);
                
                showBatchOperationLoading('📱 Génération QR codes en cours...', 'qr');
                
                const response = await fetch('/api/admin/video/generate-qr-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status_filter: filter,
                        force_regenerate: filter === 'all'
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Batch QR codes generated:', data);
                    showBatchOperationResult(`✅ ${data.message}`, `📊 ${data.generated_count} QR codes générés sur ${data.total_requests} demandes`, 'success');
                    
                    // Refresh data
                    await refreshData();
                    
                } else {
                    console.error('❌ Batch QR generation failed:', data.message);
                    showBatchOperationResult(`❌ Erreur: ${data.message}`, null, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error generating QR codes:', error);
                showBatchOperationResult(`❌ Erreur réseau: ${error.message}`, null, 'error');
            }
        }

        // Show batch operation loading state
        function showBatchOperationLoading(message, type) {
            const modal = document.getElementById('batchOpsModal');
            if (!modal) return;
            
            const existingLoader = modal.querySelector('.batch-operation-loader');
            if (existingLoader) existingLoader.remove();
            
            const loader = document.createElement('div');
            loader.className = 'batch-operation-loader';
            loader.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255,255,255,0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                border-radius: 12px;
            `;
            
            loader.innerHTML = `
                <div class="spinner" style="margin-bottom: 1rem;"></div>
                <p style="font-weight: 600; color: #6f42c1;">${message}</p>
            `;
            
            modal.querySelector('.modal-content').style.position = 'relative';
            modal.querySelector('.modal-content').appendChild(loader);
        }

        // Show batch operation result
        function showBatchOperationResult(message, details, type) {
            const modal = document.getElementById('batchOpsModal');
            if (!modal) return;
            
            const existingLoader = modal.querySelector('.batch-operation-loader');
            if (existingLoader) existingLoader.remove();
            
            const result = document.createElement('div');
            result.className = 'batch-operation-result';
            result.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255,255,255,0.98);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                border-radius: 12px;
                padding: 2rem;
                text-align: center;
            `;
            
            const iconColor = type === 'success' ? '#28a745' : '#dc3545';
            const icon = type === 'success' ? '✅' : '❌';
            
            result.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
                <h3 style="color: ${iconColor}; margin-bottom: 1rem;">${message}</h3>
                ${details ? `<p style="color: #666; margin-bottom: 2rem;">${details}</p>` : ''}
                <button class="btn" onclick="hideBatchOperationResult()" style="background: #6c757d;">Fermer</button>
            `;
            
            modal.querySelector('.modal-content').appendChild(result);
            
            // Auto-hide after 5 seconds for success
            if (type === 'success') {
                setTimeout(() => {
                    hideBatchOperationResult();
                }, 5000);
            }
        }

        // Hide batch operation result
        function hideBatchOperationResult() {
            const modal = document.getElementById('batchOpsModal');
            if (!modal) return;
            
            const result = modal.querySelector('.batch-operation-result');
            if (result) result.remove();
        }

        // Send individual confirmation email
        async function sendConfirmationEmail(submissionId) {
            try {
                console.log(`📧 Sending confirmation email for ${submissionId}`);
                
                const response = await fetch('/api/admin/email/send-confirmation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Confirmation email sent:', data);
                    alert(`✅ ${data.message}`);
                } else {
                    console.error('❌ Failed to send confirmation email:', data.message);
                    alert(`❌ Erreur: ${data.message}`);
                }
                
            } catch (error) {
                console.error('❌ Error sending confirmation email:', error);
                alert(`❌ Erreur réseau: ${error.message}`);
            }
        }

        // Send individual QR video email
        async function sendQRVideoEmail(submissionId) {
            try {
                console.log(`📱 Sending QR video email for ${submissionId}`);
                
                const response = await fetch('/api/admin/email/send-qr-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ QR video email sent:', data);
                    alert(`✅ ${data.message}`);
                } else {
                    console.error('❌ Failed to send QR video email:', data.message);
                    alert(`❌ Erreur: ${data.message}`);
                }
                
            } catch (error) {
                console.error('❌ Error sending QR video email:', error);
                alert(`❌ Erreur réseau: ${error.message}`);
            }
        }

        // Generate QR code for specific request
        async function generateQRCode(submissionId) {
            try {
                console.log(`📱 Generating QR code for ${submissionId}`);
                
                const response = await fetch('/api/admin/video/generate-qr-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status_filter: 'all',
                        force_regenerate: true,
                        submission_ids: [submissionId]
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ QR code generated:', data);
                    alert(`✅ QR code généré pour ${submissionId}`);
                    await refreshData();
                } else {
                    console.error('❌ Failed to generate QR code:', data.message);
                    alert(`❌ Erreur: ${data.message}`);
                }
                
            } catch (error) {
                console.error('❌ Error generating QR code:', error);
                alert(`❌ Erreur réseau: ${error.message}`);
            }
        }

        // ========================================
        // INITIALIZATION AND AUTO-REFRESH
        // ========================================

        // ========================================
        // UNIFIED DASHBOARD METRICS FUNCTIONS
        // ========================================

        // Refresh all unified dashboard metrics
        async function refreshUnifiedDashboard() {
            try {
                console.log('📊 Refreshing unified dashboard metrics...');
                
                // Refresh all service stats in parallel
                await Promise.all([
                    refreshPSAMetrics(),
                    refreshEmailMetrics(),
                    refreshVideoMetrics(),
                    refreshPSAStatus(), // Keep existing PSA status refresh
                    refreshData() // Keep existing data refresh
                ]);
                
                console.log('✅ Unified dashboard metrics refreshed');
                
            } catch (error) {
                console.error('❌ Error refreshing unified dashboard:', error);
            }
        }

        // Refresh PSA Scraper metrics
        async function refreshPSAMetrics() {
            try {
                // Get PSA pending count (already implemented)
                const pendingResponse = await fetch('/api/admin/psa-scraper/pending-submissions', {
                    credentials: 'include'
                });
                const pendingData = await pendingResponse.json();
                
                if (pendingData.success) {
                    const psaScrapingCount = document.getElementById('psaScrapingCount');
                    const psaScrapingStatus = document.getElementById('psaScrapingStatus');
                    
                    if (psaScrapingCount) {
                        psaScrapingCount.textContent = pendingData.count;
                    }
                    
                    if (psaScrapingStatus) {
                        const status = pendingData.count > 0 ? '⏳ En attente' : '✅ À jour';
                        psaScrapingStatus.textContent = status;
                        psaScrapingStatus.style.color = pendingData.count > 0 ? '#ffa500' : '#28a745';
                    }
                }
                
                // Get today's PSA updates count
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                
                const updatedTodayQuery = `
                    SELECT COUNT(*) as updated_today
                    FROM grading_requests 
                    WHERE psa_last_scraped >= $1
                `;
                
                // This would need a new endpoint, for now show placeholder
                const psaUpdatedToday = document.getElementById('psaUpdatedToday');
                if (psaUpdatedToday) {
                    // Estimate based on activity
                    const estimatedUpdates = Math.max(0, Math.floor(pendingData.count * 0.3));
                    psaUpdatedToday.textContent = estimatedUpdates;
                }
                
            } catch (error) {
                console.error('❌ Error refreshing PSA metrics:', error);
            }
        }

        // Refresh Email System metrics
        async function refreshEmailMetrics() {
            try {
                const response = await fetch('/api/admin/email/stats', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const emailsSentToday = document.getElementById('emailsSentToday');
                    const emailSystemStatus = document.getElementById('emailSystemStatus');
                    const pendingEmails = document.getElementById('pendingEmails');
                    
                    if (emailsSentToday) {
                        emailsSentToday.textContent = data.stats.emails_sent_today || 0;
                    }
                    
                    if (emailSystemStatus) {
                        emailSystemStatus.textContent = '🟢 Opérationnel';
                        emailSystemStatus.style.color = '#28a745';
                    }
                    
                    if (pendingEmails) {
                        pendingEmails.textContent = data.stats.pending_notifications || 0;
                    }
                }
                
            } catch (error) {
                console.error('❌ Error refreshing email metrics:', error);
                // Show error state
                const emailSystemStatus = document.getElementById('emailSystemStatus');
                if (emailSystemStatus) {
                    emailSystemStatus.textContent = '🔴 Erreur';
                    emailSystemStatus.style.color = '#dc3545';
                }
            }
        }

        // Refresh Video System metrics
        async function refreshVideoMetrics() {
            try {
                const response = await fetch('/api/admin/video/stats', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const qrCodesGenerated = document.getElementById('qrCodesGenerated');
                    const videosSubmitted = document.getElementById('videosSubmitted');
                    const videoSystemStatus = document.getElementById('videoSystemStatus');
                    
                    if (qrCodesGenerated) {
                        qrCodesGenerated.textContent = data.stats.qr_generated || 0;
                    }
                    
                    if (videosSubmitted) {
                        videosSubmitted.textContent = data.stats.videos_submitted || 0;
                    }
                    
                    if (videoSystemStatus) {
                        const pendingQR = data.stats.qr_pending || 0;
                        const status = pendingQR > 0 ? `⏳ ${pendingQR} QR en attente` : '✅ À jour';
                        videoSystemStatus.textContent = status;
                        videoSystemStatus.style.color = pendingQR > 0 ? '#ffa500' : '#28a745';
                    }
                }
                
            } catch (error) {
                console.error('❌ Error refreshing video metrics:', error);
                // Show error state
                const videoSystemStatus = document.getElementById('videoSystemStatus');
                if (videoSystemStatus) {
                    videoSystemStatus.textContent = '🔴 Erreur';
                    videoSystemStatus.style.color = '#dc3545';
                }
            }
        }

        // ========================================
        // AUTOMATED WORKFLOW FUNCTIONS
        // ========================================

        // Trigger complete workflow for a request
        async function triggerCompleteWorkflow(submissionId) {
            try {
                console.log(`🔄 Starting complete workflow for ${submissionId}`);
                
                // Step 1: Send confirmation email
                await sendConfirmationEmail(submissionId);
                
                // Small delay between steps
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 2: Generate QR code for video
                await sendQRVideoEmail(submissionId);
                
                console.log(`✅ Complete workflow triggered for ${submissionId}`);
                return true;
                
            } catch (error) {
                console.error(`❌ Error in complete workflow for ${submissionId}:`, error);
                return false;
            }
        }

        // Trigger workflow for all pending requests
        async function triggerBulkWorkflows() {
            try {
                console.log('🚀 Starting bulk workflow automation...');
                
                const confirmed = confirm('🔄 Déclencher les workflows automatiques pour toutes les demandes en attente ?\n\n• Emails de confirmation\n• QR codes vidéo\n• Mise à jour des statuts');
                
                if (!confirmed) return;
                
                // Show loading
                showBatchOperationLoading('🔄 Workflows automatiques en cours...', 'workflow');
                
                let successCount = 0;
                let errorCount = 0;
                
                // Get pending requests (would need to implement this endpoint)
                // For now, trigger bulk operations
                
                // Step 1: Send bulk confirmation emails
                try {
                    await sendBatchEmails();
                    successCount++;
                } catch (error) {
                    console.error('❌ Bulk emails failed:', error);
                    errorCount++;
                }
                
                // Small delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Step 2: Generate bulk QR codes
                try {
                    await generateBatchQRCodes();
                    successCount++;
                } catch (error) {
                    console.error('❌ Bulk QR generation failed:', error);
                    errorCount++;
                }
                
                // Show results
                const message = `✅ Workflows automatiques terminés`;
                const details = `📊 ${successCount} étapes réussies, ${errorCount} erreurs`;
                showBatchOperationResult(message, details, errorCount === 0 ? 'success' : 'warning');
                
                // Refresh dashboard
                await refreshUnifiedDashboard();
                
            } catch (error) {
                console.error('❌ Error in bulk workflows:', error);
                showBatchOperationResult(`❌ Erreur workflows: ${error.message}`, null, 'error');
            }
        }

        // Initialize PSA integration when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Initializing unified PSA dashboard...');
            
            // Initial full dashboard refresh
            setTimeout(() => {
                refreshUnifiedDashboard();
            }, 1000);
            
            // Auto-refresh unified dashboard every 30 seconds
            setInterval(() => {
                refreshUnifiedDashboard();
            }, 30000);
            
            console.log('✅ Unified PSA dashboard initialized');
        });

        // Override the old scrapeAllPSA function for backward compatibility
        function scrapeAllPSA() {
            scrapePendingSubmissions();
        }

        // Add workflow automation button action
        function showAutomationModal() {
            const confirmed = confirm('🤖 Automation PSA\n\nVoulez-vous déclencher les workflows automatiques pour optimiser le traitement ?\n\n✅ Recommandé pour traiter les demandes en attente');
            if (confirmed) {
                triggerBulkWorkflows();
            }
        }
    </script>
</body>
</html>
