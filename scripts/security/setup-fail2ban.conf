# ===============================================
# CONFIGURATION FAIL2BAN - PSA GRADING APP
# ===============================================
# üõ°Ô∏è Protection contre les attaques par force brute
# üìä Optimis√© pour Nginx, SSH et l'application PSA

[DEFAULT]
# Configuration globale
bantime = 1800          # 30 minutes de ban initial
findtime = 600          # Fen√™tre de 10 minutes pour d√©tecter les tentatives
maxretry = 5            # 5 tentatives avant ban
backend = auto          # D√©tection automatique du backend

# Configuration email (optionnel)
destemail = root@localhost
sender = fail2ban@localhost
mta = sendmail

# Actions par d√©faut
action = %(action_mwl)s

# Whitelist des IPs (IMPORTANT: Ajoutez votre IP admin!)
ignoreip = 127.0.0.1/8 ::1
           # 192.168.1.0/24  # D√©commentez et ajustez pour votre r√©seau local
           # VOTRE_IP_ADMIN   # Remplacez par votre vraie IP

# ===========================
# PROTECTION SSH
# ===========================
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3            # Seulement 3 tentatives SSH
bantime = 3600          # Ban SSH plus long: 1 heure
findtime = 300          # Fen√™tre de 5 minutes

# Protection SSH avanc√©e
[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 7200          # Ban 2 heures pour ddos SSH
findtime = 300

# ===========================
# PROTECTION NGINX/WEB
# ===========================

# Protection authentification HTTP
[nginx-http-auth]
enabled = true
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/psa-error.log
maxretry = 3
bantime = 3600
findtime = 600

# Protection contre scan de vuln√©rabilit√©s
[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/psa-access.log
maxretry = 6
bantime = 86400         # Ban 24h pour tentatives de scan
findtime = 60

# Protection contre mauvaises requ√™tes
[nginx-badbots]
enabled = true
port = http,https
filter = nginx-badbots  
logpath = /var/log/nginx/psa-access.log
maxretry = 2
bantime = 86400
findtime = 600

# Protection contre surcharge 4xx
[nginx-req-limit]
enabled = true
port = http,https
filter = nginx-req-limit
logpath = /var/log/nginx/psa-access.log
maxretry = 10
bantime = 3600
findtime = 60

# ===========================
# PROTECTION SP√âCIFIQUE PSA
# ===========================

# Protection admin PSA
[psa-admin]
enabled = true
port = http,https
filter = psa-admin
logpath = /var/log/nginx/psa-access.log
maxretry = 2            # Tr√®s restrictif pour admin
bantime = 7200
findtime = 300

# Protection login clients PSA
[psa-client-login]
enabled = true
port = http,https
filter = psa-client-login
logpath = /var/log/nginx/psa-access.log
maxretry = 5
bantime = 1800
findtime = 600

# Protection API PSA
[psa-api-limit]
enabled = true
port = http,https
filter = psa-api-limit
logpath = /var/log/nginx/psa-access.log
maxretry = 50           # Plus permissif pour API normale
bantime = 900
findtime = 60

# ===========================
# ACTIONS PERSONNALIS√âES
# ===========================

# Action avec notification email
[Definition]
actionstart = printf %%b "Subject: [Fail2Ban] PSA Security: started
              From: Fail2Ban <fail2ban@localhost>
              To: %%(dest)s
              
              Hi,
              
              The jail %%(name)s has been started successfully.
              
              Regards,
              Fail2Ban" | %%(mta)s %%(dest)s

actionstop = printf %%b "Subject: [Fail2Ban] PSA Security: stopped
             From: Fail2Ban <fail2ban@localhost>
             To: %%(dest)s
             
             Hi,
             
             The jail %%(name)s has been stopped.
             
             Regards,
             Fail2Ban" | %%(mta)s %%(dest)s

actioncheck = 

actionban = iptables -I f2b-%%(name)s 1 -s %%(ip)s -j %%(blocktype)s
            printf %%b "Subject: [Fail2Ban] PSA Security: banned %%(ip)s
            From: Fail2Ban <fail2ban@localhost>
            To: %%(dest)s
            
            Hi,
            
            The IP %%(ip)s has just been banned by Fail2Ban after
            %%(failures)s attempts against %%(name)s.
            
            Date: %%(time)s
            Jail: %%(name)s
            
            Lines containing failures:
            %%(matches)s
            
            Regards,
            Fail2Ban" | %%(mta)s %%(dest)s

actionunban = iptables -D f2b-%%(name)s -s %%(ip)s -j %%(blocktype)s

# Configuration du type de blocage
blocktype = REJECT --reject-with icmp-port-unreachable

# Variables pour l'action
mta = sendmail
dest = root@localhost