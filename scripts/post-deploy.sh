#!/bin/bash

# ===============================================
# SCRIPT POST-D√âPLOIEMENT PSA GRADING APP
# ===============================================
# üöÄ Ce script automatise les t√¢ches apr√®s d√©ploiement
# ‚ö†Ô∏è √Ä ex√©cuter apr√®s chaque mise √† jour de production

set -e  # Arr√™t imm√©diat en cas d'erreur

# Configuration
APP_DIR="/var/www/psa-grading-app"
LOG_DIR="/var/log/psa-grading"
BACKUP_DIR="/var/backups/psa-grading"
APP_USER="psa-app"

# Couleurs pour affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonctions utilitaires
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

check_user() {
    if [[ $EUID -eq 0 ]]; then
        log_error "Ce script ne doit PAS √™tre ex√©cut√© en root"
        log_info "Utilisez: su - $APP_USER puis ex√©cutez le script"
        exit 1
    fi
    
    if [[ $(whoami) != "$APP_USER" ]]; then
        log_error "Ce script doit √™tre ex√©cut√© par l'utilisateur $APP_USER"
        log_info "Utilisez: su - $APP_USER"
        exit 1
    fi
}

check_environment() {
    log_step "V√©rification de l'environnement..."
    
    # V√©rifier que nous sommes dans le bon r√©pertoire
    if [[ ! -f "$APP_DIR/package.json" ]]; then
        log_error "Fichier package.json non trouv√© dans $APP_DIR"
        exit 1
    fi
    
    # V√©rifier que NODE_ENV est en production
    if [[ "$NODE_ENV" != "production" ]]; then
        log_warn "NODE_ENV n'est pas en production (actuel: ${NODE_ENV:-'non d√©fini'})"
        export NODE_ENV=production
    fi
    
    # V√©rifier l'existence du fichier .env
    if [[ ! -f "$APP_DIR/.env" ]]; then
        log_error "Fichier .env manquant dans $APP_DIR"
        log_info "Copiez et configurez .env.production.template vers .env"
        exit 1
    fi
    
    log_info "‚úÖ Environnement valid√©"
}

create_directories() {
    log_step "Cr√©ation des r√©pertoires n√©cessaires..."
    
    # Cr√©er r√©pertoires de logs
    mkdir -p "$LOG_DIR"
    mkdir -p "$BACKUP_DIR"
    
    # Cr√©er r√©pertoires application si manquants
    mkdir -p "$APP_DIR/uploads"
    mkdir -p "$APP_DIR/uploads/cards"
    mkdir -p "$APP_DIR/uploads/videos"
    mkdir -p "$APP_DIR/uploads/qr-codes"
    
    # Permissions appropri√©es
    chmod 755 "$APP_DIR/uploads"
    chmod 755 "$LOG_DIR"
    
    log_info "‚úÖ R√©pertoires cr√©√©s et configur√©s"
}

install_dependencies() {
    log_step "Installation des d√©pendances..."
    
    cd "$APP_DIR"
    
    # Nettoyage cache npm
    npm cache clean --force 2>/dev/null || true
    
    # Installation d√©pendances production uniquement
    npm ci --production --silent
    
    log_info "‚úÖ D√©pendances install√©es"
}

database_operations() {
    log_step "Op√©rations base de donn√©es..."
    
    cd "$APP_DIR"
    
    # Test de connectivit√© base de donn√©es
    log_info "Test de connexion √† la base de donn√©es..."
    node -e "
        const { Pool } = require('pg');
        const pool = new Pool({ connectionString: process.env.DATABASE_URL });
        pool.query('SELECT NOW() as server_time')
            .then(res => {
                console.log('‚úÖ DB Connected:', res.rows[0].server_time);
                pool.end();
            })
            .catch(err => {
                console.error('‚ùå DB Error:', err.message);
                process.exit(1);
            });
    "
    
    # Initialisation tables si n√©cessaire (timeout 30s)
    log_info "V√©rification/cr√©ation des tables..."
    timeout 30s node -e "
        const { initializeDatabase } = require('./server/database/init.js');
        initializeDatabase()
            .then(() => {
                console.log('‚úÖ Database initialized');
                process.exit(0);
            })
            .catch(err => {
                console.error('‚ùå DB Init Error:', err.message);
                process.exit(1);
            });
    " 2>/dev/null || log_warn "Timeout initialisation DB (normal si tables existent)"
    
    log_info "‚úÖ Base de donn√©es op√©rationnelle"
}

optimize_application() {
    log_step "Optimisations application..."
    
    cd "$APP_DIR"
    
    # Nettoyage anciens logs (garde 7 jours)
    find "$LOG_DIR" -name "*.log" -mtime +7 -delete 2>/dev/null || true
    
    # Nettoyage uploads temporaires anciens
    find "$APP_DIR/uploads" -name "tmp_*" -mtime +1 -delete 2>/dev/null || true
    
    # Optimisation permissions
    find "$APP_DIR" -name "*.js" -exec chmod 644 {} \;
    find "$APP_DIR" -name "*.json" -exec chmod 644 {} \;
    chmod +x "$APP_DIR/scripts/"*.sh 2>/dev/null || true
    
    log_info "‚úÖ Application optimis√©e"
}

validate_configuration() {
    log_step "Validation de la configuration..."
    
    cd "$APP_DIR"
    
    # Test syntaxe fichier principal
    node -c server/index.js || {
        log_error "Erreur de syntaxe dans server/index.js"
        exit 1
    }
    
    # Validation variables d'environnement critiques
    log_info "V√©rification variables d'environnement..."
    node -e "
        const requiredVars = [
            'NODE_ENV', 'DATABASE_URL', 'ADMIN_PASSWORD', 
            'SESSION_SECRET', 'PSA_SECRET'
        ];
        
        const missing = requiredVars.filter(v => !process.env[v]);
        
        if (missing.length > 0) {
            console.error('‚ùå Variables manquantes:', missing.join(', '));
            process.exit(1);
        }
        
        console.log('‚úÖ Variables d\'environnement valid√©es');
    "
    
    # Test port disponible
    if netstat -tlnp 2>/dev/null | grep -q ":5000 "; then
        log_warn "Port 5000 d√©j√† utilis√© (normal si app d√©j√† lanc√©e)"
    fi
    
    log_info "‚úÖ Configuration valid√©e"
}

health_check() {
    log_step "V√©rification sant√© application..."
    
    # D√©marrage temporaire pour test (max 30s)
    cd "$APP_DIR"
    timeout 30s node server/index.js > /dev/null 2>&1 &
    APP_PID=$!
    
    # Attendre d√©marrage
    sleep 5
    
    # Test endpoint sant√©
    if curl -f -s http://localhost:5000/healthz > /dev/null 2>&1; then
        log_info "‚úÖ Health check r√©ussi"
    else
        log_warn "Health check √©chou√© (normal en premier d√©marrage)"
    fi
    
    # Arr√™t processus test
    kill $APP_PID 2>/dev/null || true
    wait $APP_PID 2>/dev/null || true
    
    log_info "‚úÖ Tests de sant√© termin√©s"
}

pm2_operations() {
    log_step "Configuration PM2..."
    
    cd "$APP_DIR"
    
    # V√©rifier si PM2 est install√©
    if ! command -v pm2 &> /dev/null; then
        log_error "PM2 n'est pas install√©"
        log_info "Installez PM2 avec: npm install -g pm2"
        exit 1
    fi
    
    # Sauvegarder √©tat actuel PM2
    pm2 save 2>/dev/null || true
    
    # Configuration PM2 si pas encore fait
    if ! pm2 list | grep -q "psa-grading-app"; then
        log_info "Configuration initiale PM2..."
        pm2 start ecosystem.config.js --env production
    else
        log_info "Rechargement PM2 en cours..."
        pm2 reload ecosystem.config.js --env production
    fi
    
    # Attendre stabilisation
    sleep 3
    
    # V√©rifier status PM2
    if pm2 list | grep -q "online.*psa-grading-app"; then
        log_info "‚úÖ PM2 op√©rationnel"
    else
        log_error "Probl√®me avec PM2"
        pm2 logs psa-grading-app --lines 20
        exit 1
    fi
    
    # Sauvegarde configuration PM2
    pm2 save
    
    log_info "‚úÖ PM2 configur√© et sauvegard√©"
}

security_hardening() {
    log_step "Durcissement s√©curit√©..."
    
    # V√©rification permissions critiques
    chmod 600 "$APP_DIR/.env" 2>/dev/null || true
    chmod 644 "$APP_DIR/package.json"
    chmod 755 "$APP_DIR"
    
    # V√©rification des secrets dans les logs (masquage)
    if grep -r "password\|secret\|token" "$LOG_DIR"/*.log 2>/dev/null | grep -v "MASKED\|****"; then
        log_warn "Donn√©es sensibles potentiellement pr√©sentes dans les logs"
    fi
    
    log_info "‚úÖ S√©curit√© durcie"
}

final_validation() {
    log_step "Validation finale..."
    
    # Status final PM2
    pm2 status | grep psa-grading-app || {
        log_error "Application non visible dans PM2"
        exit 1
    }
    
    # Test final health check (avec PM2)
    sleep 5
    if curl -f -s http://localhost:5000/healthz > /dev/null 2>&1; then
        log_info "‚úÖ Application d√©ploy√©e et op√©rationnelle"
    else
        log_warn "Health check final √©chou√© - v√©rifiez les logs"
        pm2 logs psa-grading-app --lines 10
    fi
    
    # Affichage m√©triques finales
    echo ""
    echo "=========================="
    echo "  D√âPLOIEMENT TERMIN√â     "
    echo "=========================="
    echo "üìä Status PM2:"
    pm2 status | grep psa-grading-app
    echo ""
    echo "üìÅ Logs disponibles:"
    echo "  - Application: pm2 logs psa-grading-app"
    echo "  - Fichiers: $LOG_DIR/"
    echo ""
    echo "üîß Commandes utiles:"
    echo "  - Red√©marrer: pm2 restart psa-grading-app"
    echo "  - Logs temps r√©el: pm2 logs psa-grading-app -f"
    echo "  - Monitoring: pm2 monit"
    echo ""
}

# ===============================================
# EX√âCUTION PRINCIPALE
# ===============================================

main() {
    log_info "üöÄ D√©marrage post-d√©ploiement PSA Grading App"
    echo "Timestamp: $(date)"
    echo "Utilisateur: $(whoami)"
    echo "R√©pertoire: $(pwd)"
    echo ""
    
    # V√©rifications pr√©liminaires
    check_user
    check_environment
    
    # Op√©rations d√©ploiement
    create_directories
    install_dependencies
    database_operations
    optimize_application
    validate_configuration
    health_check
    pm2_operations
    security_hardening
    final_validation
    
    log_info "‚úÖ Post-d√©ploiement termin√© avec succ√®s!"
    echo ""
    log_info "üåê Votre application est accessible √†: https://$(hostname -f)"
    log_info "üìä Monitoring: pm2 monit"
    log_info "üîç Health: curl https://$(hostname -f)/healthz"
}

# Capture des erreurs
trap 'log_error "Erreur lors du post-d√©ploiement √† la ligne $LINENO"' ERR

# Lancement
main "$@"